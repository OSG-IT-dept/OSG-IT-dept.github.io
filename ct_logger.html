<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vessel Temp & Gas Logger</title>
<style>
  :root{--bg:#0f1320;--panel:#141a2a;--ink:#e9eefb;--muted:#9fb0d0;--accent:#6ea8fe;--ok:#38d39f;--warn:#f7c948;--line:#223}
  *, *::before, *::after{ box-sizing: border-box; }
  /* Prevent grid/flex children from overflowing their cells */
  .row > *, .grid > * { min-width: 0; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{position:sticky;top:0;background:rgba(15,19,32,.96);backdrop-filter:saturate(140%) blur(6px);padding:12px 16px;border-bottom:1px solid var(--line);z-index:10}
  h1{margin:0;font-size:18px;line-height:1.2}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #334;color:var(--muted)}
  small.hint{color:var(--muted);font-size:11px;display:block;margin-top:6px}
  /* Responsive wrapper */
  #wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px;grid-template-columns: 1fr;}
  @media (min-width: 1100px){ #wrap{grid-template-columns: 420px 1fr;} }
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
  input,textarea,select,button{
    display:block; width:100%;
    padding:10px; border-radius:10px; border:1px solid #334;
    background:#0f1320; color:var(--ink); min-height:40px; line-height:1.25;
  }
  input[type="number"]{
    text-align:right;
    padding-right:0.8rem; /* avoid overlap with spin buttons */
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ margin:0; }
  button{background:var(--accent);border:none;cursor:pointer}
  button.secondary{background:#2a3350}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .row>*{flex:1 1 220px}
  .row.tight>*{flex:1 1 160px}
  .grid{display:grid;gap:10px}
  .grid.auto{grid-template-columns: repeat(auto-fit, minmax(160px,1fr));}
  .grid.temps{ grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:12px; }
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .right{margin-left:auto}
  .mono{font-family:ui-monospace, Menlo, Consolas, monospace}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  details summary{cursor:pointer}
  /* Ensure dropdowns/controls never overlay the next section visually */
  .spacer{height:6px}
</style>
</head>
<body>
<header>
  <h1>Vessel Temp & Gas Logger — <span id="vesselLabel" class="pill">no vessel</span> · <span id="status" class="pill">init…</span></h1>
  <div class="row tight" style="margin-top:8px">
    <div>
      <label>Vessel</label>
      <input id="inpVessel" placeholder="e.g., MV OCEAN STAR" />
    </div>
    <div>
      <label>Quick holds (this vessel)</label>
      <select id="selKnownHolds"><option value="">— None —</option></select>
    </div>
    <div>
      <label>Quick materials (this vessel)</label>
      <select id="selKnownMaterials"><option value="">— None —</option></select>
    </div>
    <div style="align-self:end">
      <button class="secondary" id="btnSetVessel">Set vessel</button>
    </div>
  </div>
  <small class="hint">Fully offline · IndexedDB storage with rolling retention · Exports JSON/CSV. Holds/materials lists learn per vessel.</small>
</header>

<div id="wrap">
  <!-- LEFT: Entry + Tools -->
  <section class="card">
    <h3 style="margin:0 0 8px">New Reading</h3>

    <div class="row">
      <div>
        <label>Hold</label>
        <input id="inpHold" placeholder="e.g., Hold 1, Forepeak, Aft Tank" />
      </div>
      <div>
        <label>Material</label>
        <input id="inpMaterial" placeholder="e.g., DRI B, coal, scrap" />
      </div>
    </div>

    <div class="row tight">
      <div>
        <label>Timestamp</label>
        <input id="inpTime" type="datetime-local" />
      </div>

      <!-- Minimal temperature count selector -->
      <div>
        <label>Temperatures · count</label>
        <div class="row tight">
          <input id="tempCount" type="number" min="1" max="12" value="3" style="flex:1 1 80px" />
          <input id="tempCountRange" type="range" min="1" max="12" value="3" style="flex:3 1 140px" />
        </div>
        <small class="hint">Choose how many temperature inputs to show (1–12).</small>
      </div>

      <div style="align-self:end">
        <button class="secondary" id="btnFillAir">Fresh air baselines</button>
      </div>
    </div>

    <label>Temperature readings</label>
    <div class="grid temps" id="tempGrid"></div>

    <div class="grid auto">
      <div><label>O₂ (%)</label><input id="inpO2" type="number" step="0.1" placeholder="20.9" /></div>
      <div><label>CO (ppm)</label><input id="inpCO" type="number" step="1" placeholder="0" /></div>
      <div><label>H₂S (ppm)</label><input id="inpH2S" type="number" step="1" placeholder="0" /></div>
      <div><label>CH₄ (%)</label><input id="inpCH4" type="number" step="0.01" placeholder="0.00" /></div>
    </div>

    <label>Notes</label>
    <textarea id="inpNotes" rows="3" placeholder="Optional observation…"></textarea>

    <div class="bar">
      <button id="btnAdd">Save reading</button>
      <span id="pending" class="pill">0 saved</span>
      <span class="right mono" id="storeInfo"></span>
    </div>

    <div class="spacer"></div>
    <hr style="border-color:var(--line);margin:14px 0">

    <h3 style="margin:0 0 8px">Backups</h3>
    <div class="row tight">
      <button class="secondary" id="btnExportJSON">Export JSON</button>
      <button class="secondary" id="btnExportCSV">Export CSV</button>
      <input id="fileImport" type="file" accept=".json,application/json" />
      <button id="btnImport">Import JSON</button>
    </div>
    <div class="bar">
      <button class="secondary" id="btnPickFile">Pick rolling backup file (optional)</button>
      <span id="fsStatus" class="pill">no file</span>
    </div>

    <div class="spacer"></div>
    <hr style="border-color:var(--line);margin:14px 0">

    <h3 style="margin:0 0 8px">Retention</h3>
    <div class="row tight">
      <select id="selDays">
        <option value="30" selected>Keep 30 days</option>
        <option value="60">Keep 60 days</option>
        <option value="90">Keep 90 days</option>
        <option value="365">Keep 365 days</option>
      </select>
      <button class="secondary" id="btnPurge">Purge now</button>
    </div>
  </section>

  <!-- RIGHT: Records -->
  <section class="card">
    <div class="row" style="align-items:flex-end">
      <div style="flex:1 1 100%">
        <h3 style="margin:0 0 8px">Recorded Readings</h3>
        <div class="row tight">
          <div><label>From</label><input id="fltFrom" type="date"></div>
          <div><label>To</label><input id="fltTo" type="date"></div>
          <div><label>Vessel</label><input id="fltVessel" placeholder="(all vessels)"></div>
          <div><label>Hold</label><input id="fltHold" placeholder="(all holds)"></div>
          <div><label>Material</label><input id="fltMaterial" placeholder="(all materials)"></div>
          <div style="align-self:end"><button class="secondary" id="btnFilter">Filter</button></div>
        </div>
      </div>
      <div>
        <label>Show</label>
        <select id="selLimit"><option>100</option><option selected>500</option><option>2000</option><option>All</option></select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date/Time</th><th>Vessel</th><th>Hold</th><th>Material</th>
          <th>Avg °C</th><th>n</th><th>O₂ %</th><th>CO ppm</th><th>H₂S ppm</th><th>CH₄ %</th>
          <th>Temps</th><th>Notes</th><th></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>
</div>

<script>
/* ===== DB setup (same schema as before) ===== */
const DB_NAME='tempGasLoggerDB', DB_VER=3, STORE='logs'; let db;
const openReq=indexedDB.open(DB_NAME,DB_VER);
openReq.onupgradeneeded=(e)=>{const _db=e.target.result;const os=_db.objectStoreNames.contains(STORE)?e.target.transaction.objectStore(STORE):_db.createObjectStore(STORE,{keyPath:'id'}); if(!os.indexNames.contains('ts'))os.createIndex('ts','ts'); if(!os.indexNames.contains('vessel'))os.createIndex('vessel','vessel'); if(!os.indexNames.contains('hold'))os.createIndex('hold','hold'); if(!os.indexNames.contains('material'))os.createIndex('material','material');};
openReq.onsuccess=(e)=>{db=e.target.result;initUI();};
openReq.onerror=()=>alert('Failed to open local store.');

/* ===== Utils ===== */
const $=id=>document.getElementById(id);
const fmtDT=ms=>new Date(ms).toLocaleString();
const daysToMs=d=>d*24*60*60*1000;
const LS_VESSEL='tempGasLogger_vessel', LS_HOLDS='tempGasLogger_knownHolds', LS_MATS='tempGasLogger_knownMaterials';
function tx(mode='readonly'){return db.transaction([STORE],mode).objectStore(STORE);}
function getVessel(){return (localStorage.getItem(LS_VESSEL)||'').trim();}
function setVessel(v){localStorage.setItem(LS_VESSEL,v.trim());uiVessel();refreshKnownHolds();refreshKnownMaterials();}
function _addKnown(mapKey,vessel,value){if(!vessel||!value)return;const map=JSON.parse(localStorage.getItem(mapKey)||'{}');const set=new Set(map[vessel]||[]);set.add(value);map[vessel]=[...set].sort();localStorage.setItem(mapKey,JSON.stringify(map));}
const addKnownHold=(v,h)=>{_addKnown(LS_HOLDS,v,h);refreshKnownHolds();};
const addKnownMaterial=(v,m)=>{_addKnown(LS_MATS,v,m);refreshKnownMaterials();};
const knownHolds=v=>{const m=JSON.parse(localStorage.getItem(LS_HOLDS)||'{}');return m[v]||[];};
const knownMaterials=v=>{const m=JSON.parse(localStorage.getItem(LS_MATS)||'{}');return m[v]||[];};

/* ===== Data ops ===== */
function addReading(rec){
  return new Promise((res,rej)=>{
    const temps=(rec.temps||[]).map(x=>x===''?null:Number(x)).filter(x=>x!=null&&!Number.isNaN(x)).slice(0,12);
    const avg=temps.length?temps.reduce((a,b)=>a+b,0)/temps.length:null;
    const safe={id:crypto.randomUUID(),ts:rec.ts??Date.now(),vessel:String(rec.vessel||'').trim(),hold:String(rec.hold||'').trim(),material:String(rec.material||'').trim(),temps,temp_avg:avg,temp_n:temps.length,o2:rec.o2===''?null:Number(rec.o2),co:rec.co===''?null:Number(rec.co),h2s:rec.h2s===''?null:Number(rec.h2s),ch4:rec.ch4===''?null:Number(rec.ch4),notes:(rec.notes||'').trim()};
    tx('readwrite').put(safe).onsuccess=()=>res(safe);
  });
}
function deleteReading(id){return new Promise(res=>tx('readwrite').delete(id).onsuccess=res);}
function listReadings({from,to,vessel,hold,material,limit}={}){
  return new Promise(res=>{
    const out=[]; const idx=tx().index('ts');
    const range=(from||to)?IDBKeyRange.bound(from||0,to||Number.MAX_SAFE_INTEGER):null;
    (range?idx.openCursor(range,'prev'):idx.openCursor(null,'prev')).onsuccess=e=>{
      const c=e.target.result; if(!c) return res(out);
      if(limit && out.length>=limit) return res(out);
      const R=c.value; const v=(vessel||'').toLowerCase(),h=(hold||'').toLowerCase(),m=(material||'').toLowerCase();
      const okV=!v||String(R.vessel||'').toLowerCase().includes(v);
      const okH=!h||String(R.hold||'').toLowerCase().includes(h);
      const okM=!m||String(R.material||'').toLowerCase().includes(m);
      if(okV&&okH&&okM) out.push(R);
      c.continue();
    };
  });
}
function countAll(){return new Promise(res=>tx().count().onsuccess=e=>res(e.target.result));}
function purgeOld(days){
  return new Promise(res=>{
    const cutoff=Date.now()-daysToMs(days); const store=tx('readwrite'); const idx=store.index('ts'); const range=IDBKeyRange.upperBound(cutoff,true);
    let removed=0; idx.openCursor(range).onsuccess=e=>{const c=e.target.result; if(!c){res(removed);return;} store.delete(c.primaryKey); removed++; c.continue();};
  });
}

/* ===== Rolling file backup (optional) ===== */
let fileHandle=null;
async function pickBackupFile(){
  if(!('showSaveFilePicker' in window)){ $('fsStatus').textContent='not supported'; return; }
  fileHandle=await showSaveFilePicker({suggestedName:'vessel-temp-gas.jsonl',types:[{description:'JSON Lines',accept:{'application/json':['.jsonl','.json']}}]});
  $('fsStatus').textContent='file linked';
}
async function appendBackup(rec){
  try{ if(!fileHandle) return;
    const writable=await fileHandle.createWritable({keepExistingData:true});
    await writable.seek((await fileHandle.getFile()).size);
    await writable.write(JSON.stringify(rec)+"\n");
    await writable.close();
  }catch(_){}
}

/* ===== Export / Import ===== */
async function exportJSON(){const all=await listReadings({limit:null}); const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`vessel-temp-gas-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; a.click(); URL.revokeObjectURL(a.href);}
async function exportCSV(){
  const all=await listReadings({limit:null}); const esc=s=>`"${String(s??'').replace(/"/g,'""')}"`;
  const header=['id','timestamp_iso','vessel','hold','material','avg_c','n','o2_pct','co_ppm','h2s_ppm','ch4_pct'].concat(Array.from({length:12},(_,i)=>`temp${i+1}_c`));
  const rows=[header].concat(all.map(r=>{const temps=Array.from({length:12},(_,i)=>r.temps?.[i]??''); return [r.id,new Date(r.ts).toISOString(),r.vessel,r.hold,r.material,r.temp_avg??'',r.temp_n??0,r.o2??'',r.co??'',r.h2s??'',r.ch4??''].concat(temps);})).map(a=>a.map(esc).join(',')).join('\n');
  const blob=new Blob([rows],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`vessel-temp-gas-${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
}
async function importJSON(file){
  const text=await file.text(); const arr=JSON.parse(text); const store=tx('readwrite');
  await new Promise(res=>{let i=0;(function putNext(){ if(i>=arr.length) return res(); const r=arr[i++]; const temps=(r.temps||Array.from({length:12},(_,k)=>r[`temp${k+1}_c`])).filter(x=>x!==undefined);
    const safe={id:r.id||crypto.randomUUID(),ts:Number(r.ts||Date.parse(r.timestamp_iso)||Date.now()),vessel:String(r.vessel||''),hold:String(r.hold||''),material:String(r.material||''),temps:temps.map(x=>x===''?null:Number(x)).filter(x=>x!=null&&!Number.isNaN(x)).slice(0,12),temp_avg:r.temp_avg??null,temp_n:r.temp_n??null,o2:r.o2??r.o2_pct??null,co:r.co??r.co_ppm??null,h2s:r.h2s??r.h2s_ppm??null,ch4:r.ch4??r.ch4_pct??null,notes:String(r.notes||'')};
    if(safe.temp_n==null||safe.temp_avg==null){safe.temp_n=safe.temps.length; safe.temp_avg=safe.temp_n?safe.temps.reduce((a,b)=>a+b,0)/safe.temp_n:null;}
    store.put(safe).onsuccess=putNext; })(); });
}

/* ===== UI ===== */
function uiVessel(){const v=getVessel()||'no vessel'; $('vesselLabel').textContent=v; $('fltVessel').value=getVessel();}
function refreshKnownHolds(){const holds=knownHolds(getVessel()); $('selKnownHolds').innerHTML='<option value="">— None —</option>'+holds.map(h=>`<option>${h}</option>`).join('');}
function refreshKnownMaterials(){const mats=knownMaterials(getVessel()); $('selKnownMaterials').innerHTML='<option value="">— None —</option>'+mats.map(m=>`<option>${m}</option>`).join('');}

function buildTempGrid(count=3){
  const g=$('tempGrid'); g.innerHTML='';
  for(let i=1;i<=12;i++){
    const wrap=document.createElement('div');
    wrap.style.display = i<=count ? '' : 'none';
    wrap.innerHTML=`<input id="t${i}" type="number" step="0.1" placeholder="Temp ${i} (°C)${i===1?' *':''}">`;
    g.appendChild(wrap);
  }
}
function readTemps(count){const arr=[]; for(let i=1;i<=count;i++){const v=$('t'+i).value; if(v!=='') arr.push(v);} return arr;}

async function render(){
  const from=$('fltFrom').value?new Date($('fltFrom').value).setHours(0,0,0,0):null;
  const to=$('fltTo').value?new Date($('fltTo').value).setHours(23,59,59,999):null;
  const vessel=$('fltVessel').value.trim(), hold=$('fltHold').value.trim(), material=$('fltMaterial').value.trim();
  const limV=$('selLimit').value; const limit=(limV==='All')?null:Number(limV);
  const recs=await listReadings({from,to,vessel,hold,material,limit});
  const tb=$('rows'); tb.innerHTML='';
  for(const r of recs){
    const warn=(x,th)=>(x!=null&&x>=th)?'warn':'ok';
    const tempsStr=(r.temps&&r.temps.length)?r.temps.map(x=>Number(x).toFixed(1)).join(', '):'';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="mono">${fmtDT(r.ts)}</td>
      <td>${(r.vessel||'').replace(/</g,'&lt;')}</td>
      <td>${(r.hold||'').replace(/</g,'&lt;')}</td>
      <td>${(r.material||'').replace(/</g,'&lt;')}</td>
      <td class="${warn(r.temp_avg,50)} mono">${r.temp_avg==null?'':r.temp_avg.toFixed(1)}</td>
      <td class="mono">${r.temp_n??0}</td>
      <td class="${warn(r.o2,23.5)} mono">${r.o2==null?'':Number(r.o2).toFixed(1)}</td>
      <td class="${warn(r.co,25)} mono">${r.co==null?'':Number(r.co).toFixed(0)}</td>
      <td class="${warn(r.h2s,5)} mono">${r.h2s==null?'':Number(r.h2s).toFixed(0)}</td>
      <td class="${warn(r.ch4,1)} mono">${r.ch4==null?'':Number(r.ch4).toFixed(2)}</td>
      <td><details><summary>view</summary><div class="mono">${tempsStr}</div></details></td>
      <td>${(r.notes||'').replace(/</g,'&lt;')}</td>
      <td><button class="secondary" data-id="${r.id}">Delete</button></td>`;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('button[data-id]').forEach(btn=>{btn.onclick=async()=>{await deleteReading(btn.dataset.id); render(); updateCounts();};});
}

async function updateCounts(){const n=await countAll(); $('pending').textContent=`${n} saved locally`;}

/* ===== Init & Handlers ===== */
async function initUI(){
  $('status').textContent='local store ready';
  $('inpTime').value=new Date().toISOString().slice(0,16);
  $('selDays').value='30';
  $('storeInfo').textContent=`DB:${DB_NAME} • Store:${STORE}`;
  $('inpVessel').value=getVessel();
  uiVessel(); refreshKnownHolds(); refreshKnownMaterials();

  // temperature count selector
  const syncCount=()=>{ $('tempCountRange').value=$('tempCount').value; buildTempGrid(Number($('tempCount').value)); };
  $('tempCount').oninput=syncCount; $('tempCountRange').oninput=()=>{ $('tempCount').value=$('tempCountRange').value; syncCount(); };
  syncCount();

  await purgeOld(Number($('selDays').value));
  await render(); updateCounts();

  $('btnSetVessel').onclick=()=>{ setVessel($('inpVessel').value); render(); };
  $('selKnownHolds').onchange=()=>{ const v=$('selKnownHolds').value; if(v) $('inpHold').value=v; };
  $('selKnownMaterials').onchange=()=>{ const v=$('selKnownMaterials').value; if(v) $('inpMaterial').value=v; };

  $('btnFillAir').onclick=()=>{ if(!$('inpO2').value)$('inpO2').value='20.9'; if(!$('inpCO').value)$('inpCO').value='0'; if(!$('inpH2S').value)$('inpH2S').value='0'; if(!$('inpCH4').value)$('inpCH4').value='0.00'; };

  $('btnAdd').onclick=async()=>{
    const vessel=getVessel(); if(!vessel){alert('Set the Vessel first.');return;}
    const hold=$('inpHold').value.trim(); if(!hold){alert('Enter the Hold.');return;}
    const material=$('inpMaterial').value.trim();
    const count=Number($('tempCount').value);
    const temps=readTemps(count); if(temps.length===0){alert('Enter at least one temperature.');return;}
    const ts=$('inpTime').value?new Date($('inpTime').value).getTime():Date.now();
    const rec=await addReading({vessel,hold,material,ts,temps,o2:$('inpO2').value,co:$('inpCO').value,h2s:$('inpH2S').value,ch4:$('inpCH4').value,notes:$('inpNotes').value});
    addKnownHold(vessel,hold); if(material) addKnownMaterial(vessel,material); appendBackup(rec);
    // reset
    $('inpNotes').value=''; ['inpO2','inpCO','inpH2S','inpCH4'].forEach(id=>$(id).value=''); for(let i=1;i<=12;i++){$('t'+i)&&($('t'+i).value='');}
    $('t1')?.focus(); $('inpTime').value=new Date().toISOString().slice(0,16);
    render(); updateCounts();
  };

  $('btnFilter').onclick=render;
  ['selLimit','fltVessel','fltHold','fltMaterial'].forEach(id=>$(id).onchange=render);

  $('btnExportJSON').onclick=exportJSON; $('btnExportCSV').onclick=exportCSV;
  $('btnImport').onclick=async()=>{const f=$('fileImport').files[0]; if(!f) return alert('Choose a JSON file first.'); await importJSON(f); await render(); updateCounts();};

  $('btnPurge').onclick=async()=>{const d=Number($('selDays').value); const n=await purgeOld(d); await render(); updateCounts(); alert(`Purged ${n} records older than ${d} days.`);};
  $('btnPickFile').onclick=pickBackupFile;

  // periodic retention
  setInterval(async()=>{await purgeOld(Number($('selDays').value)); updateCounts();},6*60*60*1000);
}
</script>
</body>
</html>
