<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSG Bulk Image Downscaler (Preserve Folder Structure)</title>
  <style>
    body {font-family: system-ui, sans-serif; background: #0b1020; color: #e8eeff; margin: 0; padding: 0;}
    .container {max-width: 800px; margin: 40px auto; background: #121832; padding: 24px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.4);}
    h1 {margin-top: 0; color: #7aa2ff;}
    label {display: block; margin-top: 12px; margin-bottom: 4px; font-weight: bold;}
    input, select {width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #2a366f; background: #0d1430; color: #e8eeff;}
    button {background: #7aa2ff; border: none; color: #0b1020; padding: 10px 16px; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 16px;}
    button:disabled {opacity: 0.6; cursor: not-allowed;}
    progress {width: 100%; height: 18px; margin-top: 16px;}
    .muted {color: #9fb0d0; font-size: 13px;}
    .thumbs {display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px; margin-top:20px;}
    .thumb {background:#0d1330; border:1px solid #223068; border-radius:12px; padding:6px; text-align:center;}
    .thumb img{width:100%; border-radius:8px; object-fit:cover;}
  </style>
</head>
<body>
  <div class="container">
    <h1>OSG Bulk Image Downscaler</h1>
    <p class="muted">Select a structured folder containing subfolders of images. The tool will resize images and generate a ZIP while preserving the original folder hierarchy. Runs entirely offline.</p>

    <label>Select root folder</label>
    <input id="inputDir" type="file" webkitdirectory multiple accept="image/*" />

    <label>Max width (px)</label>
    <input id="maxW" type="number" min="1" value="1920" />

    <label>Max height (px)</label>
    <input id="maxH" type="number" min="1" value="1080" />

    <label>Output format</label>
    <select id="format">
      <option value="image/jpeg">JPEG (.jpg)</option>
      <option value="image/webp">WebP (.webp)</option>
      <option value="image/png">PNG (.png)</option>
    </select>

    <label>Quality (0.1–1.0)</label>
    <input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.8">
    <div class="muted">Current: <span id="qVal">0.8</span></div>

    <label>Filename suffix</label>
    <input id="suffix" type="text" value="-small" />

    <label>Skip smaller than target?</label>
    <select id="skipSmall">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <button id="btnStart">Start & Download ZIP</button>

    <progress id="prog" value="0" max="100"></progress>
    <div id="status" class="muted">Idle</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const $ = (s)=>document.querySelector(s);
    const inputDir=$('#inputDir'), maxW=$('#maxW'), maxH=$('#maxH'), quality=$('#quality'), qVal=$('#qVal'), formatSel=$('#format'), suffix=$('#suffix'), skipSmall=$('#skipSmall'), btnStart=$('#btnStart'), prog=$('#prog'), status=$('#status');

    let files=[];
    quality.addEventListener('input',()=>qVal.textContent=quality.value);

    inputDir.addEventListener('change',()=>{
      files=Array.from(inputDir.files).filter(f=>f.type.startsWith('image/'));
      status.textContent=`Loaded ${files.length} image(s)`;
    });

    async function loadImage(file){const bmp=await createImageBitmap(file);return {bmp,width:bmp.width,height:bmp.height};}
    function calcSize(w,h,maxW,maxH){const s=Math.min(maxW/w,maxH/h,1);return {tw:Math.round(w*s),th:Math.round(h*s),scaled:s<1};}

    async function resize(bmp,tw,th,type,q){const c=document.createElement('canvas');c.width=tw;c.height=th;const ctx=c.getContext('2d');ctx.imageSmoothingEnabled=true;ctx.imageSmoothingQuality='high';ctx.drawImage(bmp,0,0,tw,th);return new Promise(r=>c.toBlob(b=>r(b),type,type.includes('jpeg')||type.includes('webp')?q:undefined));}

    async function start(){
      if(!files.length){alert('Select a structured folder first');return;}
      btnStart.disabled=true;status.textContent='Processing...';prog.value=0;
      const zip=new JSZip();
      const maxw=+maxW.value,maxh=+maxH.value,q=+quality.value,type=formatSel.value;
      let done=0;
      for(const f of files){
        try{
          const {bmp,width,height}=await loadImage(f);
          const {tw,th,scaled}=calcSize(width,height,maxw,maxh);
          if(skipSmall.value==='yes'&&!scaled){done++;continue;}
          const blob=await resize(bmp,tw,th,type,q);
          const ext=type==='image/jpeg'?'.jpg':type==='image/png'?'.png':'.webp';
          const base=f.name.replace(/\.[^/.]+$/,'');
          const outName=base+suffix.value+ext;
          // preserve relative path
          const rel=f.webkitRelativePath?f.webkitRelativePath.replace(/^[^/]+\//,''):'/' + f.name;
          const dirPath=rel.substring(0,rel.lastIndexOf('/')+1);
          const fullPath=dirPath+outName;
          zip.file(fullPath,blob);
        }catch(e){console.error(e);}
        done++;prog.value=(done/files.length)*100;status.textContent=`Processed ${done}/${files.length}`;
      }
      const blob=await zip.generateAsync({type:'blob'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='downscaled_images.zip';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},2000);
      status.textContent='ZIP downloaded ✅';
      btnStart.disabled=false;
    }

    btnStart.addEventListener('click',start);
  </script>
</body>
</html>
