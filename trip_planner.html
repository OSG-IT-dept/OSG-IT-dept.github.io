<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Surveyor Trip Planner (HTML Only)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root { --bg:#0b1020; --card:#111832; --muted:#0e1530; --text:#e7ecff; --sub:#a8b3d0; --accent:#7aa2ff; --border:#263056; --good:#42d392; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial; color:var(--text); background:linear-gradient(180deg,#0b1020,#0d1230 40%, #0a1026); }
    .wrap { max-width:1280px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 380px 1fr; gap:16px; }
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }
    .card { background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01)); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.25); overflow:hidden; }
    .card h2 { margin:0; padding:14px 16px; font-size:16px; border-bottom:1px solid var(--border); background:rgba(122,162,255,0.08); }
    .card .content { padding:14px 16px; }
    label { display:block; font-size:12px; color:var(--sub); margin-bottom:6px; }
    input, select, textarea { width:100%; background:#0f1733; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px; }
    textarea { resize:vertical; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btns { display:flex; flex-wrap:wrap; gap:8px; }
    button, .btn { background:#15214a; color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    button:hover, .btn:hover { background:#1a2a60; }
    button.outline { background:transparent; }
    small.tip { color:var(--sub); display:block; margin-top:6px; }
    .stop { border:1px solid var(--border); border-radius:14px; padding:10px; margin-bottom:10px; background:rgba(255,255,255,0.02); }
    .stop .head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; font-weight:600; }
    .iconbtn { background:transparent; border:0; color:var(--sub); padding:6px; cursor:pointer; }
    .iconbtn:disabled { opacity:.4; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:8px 6px; border-bottom:1px solid var(--border); text-align:left; }
    .kpis { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; }
    @media (max-width: 640px){ .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .kpi { text-align:center; border:1px solid var(--border); border-radius:14px; padding:10px; }
    .kpi .lab { font-size:12px; color:var(--sub); }
    .kpi .val { font-size:18px; font-weight:700; margin-top:4px; }
    #map { height:460px; width:100%; }
    .marker-num { background:var(--accent); color:#06122b; border:2px solid white; border-radius:999px; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; box-shadow:0 2px 8px rgba(0,0,0,.5); }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Form -->
    <div class="card">
      <h2>Surveyor Trip Planner</h2>
      <div class="content">
        <div class="row">
          <div>
            <label>Plan name</label>
            <input id="planName" placeholder="New Trip Plan" />
          </div>
          <div>
            <label>Start date</label>
            <input id="startDate" type="datetime-local" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>REF_OSG (Work Order)</label>
            <input id="refOSG" placeholder="OSG-2025-1042" />
          </div>
          <div>
            <label>Default travel mode</label>
            <select id="defaultMode">
              <option value="car">Car</option>
              <option value="ferry">Ferry</option>
              <option value="flight">Flight</option>
              <option value="walk">Walk</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Client</label>
            <input id="client" />
          </div>
          <div>
            <label>Vessel</label>
            <input id="vessel" />
          </div>
        </div>
        <div>
          <label>Operator / Agency</label>
          <input id="operator" />
        </div>
        <div>
          <label>General notes</label>
          <textarea id="notes" rows="3" placeholder="Lodging, permits, PPE, parking, site access, etc."></textarea>
        </div>

        <div class="btns" style="margin-top:10px;">
          <button id="btnAdd">Add stop</button>
          <button id="btnOptimize">Optimize order</button>
          <label class="btn" style="display:inline-flex; align-items:center; gap:8px;">
            <input id="importJSON" type="file" accept="application/json" style="display:none" />
            Import JSON
          </label>
          <button id="btnExportCSV" class="outline">Export CSV</button>
          <button id="btnExportJSON" class="outline">Export JSON</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Map -->
    <div class="card">
      <h2>Map & Route</h2>
      <div class="content">
        <div id="map"></div>
        <small class="tip">Tip: click anywhere on the map to add a stop; then edit the details below.</small>
      </div>
    </div>

    <!-- LEFT (second row): Stops -->
    <div class="card">
      <h2>Stops & Time Windows</h2>
      <div class="content" id="stops"></div>
    </div>

    <!-- RIGHT (second row): Summary -->
    <div class="card">
      <h2>Route Summary</h2>
      <div class="content">
        <div class="kpis" id="kpis"></div>
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>Leg</th>
                <th>From â†’ To</th>
                <th>Mode</th>
                <th>Dist (km)</th>
                <th>ETA (h)</th>
              </tr>
            </thead>
            <tbody id="legs"></tbody>
          </table>
        </div>
        <div id="timing" style="margin-top:10px; color:var(--sub);"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const R = 6371000; // m
    const km = m => m/1000;
    const speeds = { car:80, ferry:25, flight:700, walk:5 };
    function haversine(a,b){
      const toRad = d => d*Math.PI/180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat); const lat2 = toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function estHours(distanceKm, mode){ return distanceKm / (speeds[mode] ?? 60); }
    function fmt(n, d=1){ return Number(n).toFixed(d); }
    function download(filename, text){
      const blob = new Blob([text], {type: filename.endsWith('.json')? 'application/json' : 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // ---------- State ----------
    const meta = {
      planName: 'New Trip Plan', refOSG: '', client:'', vessel:'', operator:'', startDate:'', notes:'', defaultMode:'car'
    };
    let stops = [];
    let map, markers = [], line;

    // ---------- UI Elements ----------
    const el = id => document.getElementById(id);
    const inputs = {
      planName: el('planName'), refOSG: el('refOSG'), client: el('client'), vessel: el('vessel'), operator: el('operator'), startDate: el('startDate'), notes: el('notes'), defaultMode: el('defaultMode')
    };

    Object.entries(inputs).forEach(([k, node]) => {
      node.addEventListener('input', () => { meta[k] = node.value; renderAll(); });
      node.addEventListener('change', () => { meta[k] = node.value; renderAll(); });
    });

    // ---------- Map ----------
    const defaultCenter = { lat: 40.4168, lng: -3.7038 }; // Madrid
    map = L.map('map').setView([defaultCenter.lat, defaultCenter.lng], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
    map.on('click', (e) => addStop({ lat:e.latlng.lat, lng:e.latlng.lng }));

    function markerIcon(n){
      return L.divIcon({ className:'', html:`<div class="marker-num">${n}</div>`, iconSize:[24,24], iconAnchor:[12,12] });
    }

    function refreshMap(){
      markers.forEach(m => m.remove()); markers = [];
      if(line){ line.remove(); line = null; }
      stops.forEach((s, i) => {
        const m = L.marker([s.lat, s.lng], { icon: markerIcon(i+1) }).addTo(map);
        markers.push(m);
      });
      if(stops.length>1){
        line = L.polyline(stops.map(s=>[s.lat, s.lng])).addTo(map);
        const b = L.latLngBounds(stops.map(s=>[s.lat, s.lng]));
        map.fitBounds(b.pad(0.2));
      }
    }

    // ---------- Stops CRUD ----------
    function addStop(pt, preset={}){
      stops.push({
        name: preset.name || `Stop ${stops.length+1}`,
        lat: pt?.lat ?? defaultCenter.lat,
        lng: pt?.lng ?? defaultCenter.lng,
        address: preset.address || '',
        windowStart: '', windowEnd: '',
        dwellHours: 1,
        mode: meta.defaultMode,
        contact: '',
        notes: ''
      });
      renderAll();
    }
    function removeStop(idx){ stops.splice(idx,1); renderAll(); }
    function moveStop(idx, dir){ const j=idx+dir; if(j<0||j>=stops.length) return; const [it]=stops.splice(idx,1); stops.splice(j,0,it); renderAll(); }

    // ---------- Compute route ----------
    function computeRoute(){
      if(stops.length<2) return { legs:[], totalKm:0, travelHours:0, totalHours: (stops.reduce((a,s)=>a+Number(s.dwellHours||0),0)) };
      const legs=[]; let totalKm=0, travelHours=0;
      for(let i=0;i<stops.length-1;i++){
        const a=stops[i], b=stops[i+1];
        const dkm = km(haversine(a,b));
        const mode = a.mode || meta.defaultMode;
        const h = estHours(dkm, mode);
        legs.push({from:i, to:i+1, km:dkm, hours:h, mode});
        totalKm+=dkm; travelHours+=h;
      }
      const dwell = stops.reduce((a,s)=>a+Number(s.dwellHours||0),0);
      return { legs, totalKm, travelHours, totalHours: travelHours + dwell };
    }

    function optimize(){
      if(stops.length<3) return;
      const remaining = stops.slice(1);
      const ordered=[stops[0]]; let cursor=stops[0];
      while(remaining.length){
        let best=0, bestD=Infinity;
        for(let i=0;i<remaining.length;i++){
          const d=haversine(cursor, remaining[i]);
          if(d<bestD){ bestD=d; best=i; }
        }
        const next = remaining.splice(best,1)[0];
        ordered.push(next); cursor=next;
      }
      stops = ordered; renderAll();
    }

    // ---------- Renderers ----------
    function renderStops(){
      const host = document.getElementById('stops');
      host.innerHTML='';
      if(stops.length===0){ host.innerHTML = '<small class="tip">No stops yet. Add one on the map or with the button above.</small>'; return; }
      stops.forEach((s, idx)=>{
        const div = document.createElement('div'); div.className='stop';
        div.innerHTML = `
          <div class="head">
            <div>#${idx+1} â€” <span>${s.name || ''}</span></div>
            <div>
              <button class="iconbtn" data-act="up">â–²</button>
              <button class="iconbtn" data-act="down">â–¼</button>
              <button class="iconbtn" data-act="del">ðŸ—‘</button>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Name</label>
              <input data-k="name" value="${escapeHtml(s.name)}" />
            </div>
            <div>
              <label>Address / Place</label>
              <input data-k="address" value="${escapeHtml(s.address||'')}" placeholder="Optional" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Lat</label>
              <input data-k="lat" type="number" step="0.000001" value="${s.lat}" />
            </div>
            <div>
              <label>Lng</label>
              <input data-k="lng" type="number" step="0.000001" value="${s.lng}" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Window start</label>
              <input data-k="windowStart" type="datetime-local" value="${s.windowStart||''}" />
            </div>
            <div>
              <label>Window end</label>
              <input data-k="windowEnd" type="datetime-local" value="${s.windowEnd||''}" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Dwell (hrs)</label>
              <input data-k="dwellHours" type="number" min="0" step="0.25" value="${s.dwellHours}" />
            </div>
            <div>
              <label>Leg mode</label>
              <select data-k="mode">
                ${['car','ferry','flight','walk'].map(m=>`<option value="${m}" ${s.mode===m?'selected':''}>${cap(m)}</option>`).join('')}
              </select>
            </div>
          </div>
          <div>
            <label>Contact</label>
            <input data-k="contact" value="${escapeHtml(s.contact||'')}" placeholder="Name / phone / email" />
          </div>
          <div>
            <label>Notes</label>
            <textarea data-k="notes" rows="2">${escapeHtml(s.notes||'')}</textarea>
          </div>
        `;
        // wire inputs
        div.querySelectorAll('input, select, textarea').forEach(inp=>{
          inp.addEventListener('input', ()=>{
            const k = inp.getAttribute('data-k');
            let v = inp.value;
            if(k==='lat'||k==='lng'||k==='dwellHours') v = parseFloat(v);
            stops[idx][k]=v; renderAll();
          });
        });
        div.querySelector('[data-act="up"]').disabled = idx===0;
        div.querySelector('[data-act="down"]').disabled = idx===stops.length-1;
        div.querySelector('[data-act="up"]').onclick = ()=>moveStop(idx,-1);
        div.querySelector('[data-act="down"]').onclick = ()=>moveStop(idx, +1);
        div.querySelector('[data-act="del"]').onclick = ()=>removeStop(idx);
        host.appendChild(div);
      });
    }

    function renderSummary(){
      const route = computeRoute();
      const kpis = [
        ['Total distance', `${fmt(route.totalKm)} km`],
        ['Travel time', `${fmt(route.travelHours)} h`],
        ['Dwell time', `${fmt(stops.reduce((a,s)=>a+Number(s.dwellHours||0),0))} h`],
        ['Total time', `${fmt(route.totalHours)} h`],
      ];
      const k = document.getElementById('kpis');
      k.innerHTML = kpis.map(([l,v])=>`<div class="kpi"><div class="lab">${l}</div><div class="val">${v}</div></div>`).join('');

      const legs = document.getElementById('legs');
      legs.innerHTML = route.legs.map((leg,i)=>`<tr>
        <td>${i+1}</td>
        <td>#${leg.from+1} ${escapeHtml(stops[leg.from]?.name||'')} â†’ #${leg.to+1} ${escapeHtml(stops[leg.to]?.name||'')}</td>
        <td style="text-transform:capitalize">${leg.mode}</td>
        <td>${fmt(leg.km)}</td>
        <td>${fmt(leg.hours,2)}</td>
      </tr>`).join('');

      const t = document.getElementById('timing');
      if(meta.startDate){
        const start = new Date(meta.startDate);
        const finish = new Date(start.getTime() + route.totalHours*3600*1000);
        t.textContent = `Planned start: ${start.toLocaleString()} â€” Projected finish: ${finish.toLocaleString()}`;
      } else { t.textContent = ''; }
    }

    function renderAll(){
      // push meta fields into inputs if empty initial
      Object.entries(inputs).forEach(([k,node])=>{ if(node.value!==meta[k]) node.value = meta[k]; });
      renderStops();
      renderSummary();
      refreshMap();
    }

    // ---------- Import/Export ----------
    function exportCSV(){
      const headers = ["Order","Name","Address","Lat","Lng","Contact","WindowStart","WindowEnd","DwellHours","Mode","Notes"];
      const rows = stops.map((s,i)=>[
        i+1, s.name, s.address||'', s.lat, s.lng, s.contact||'', s.windowStart||'', s.windowEnd||'', s.dwellHours||0, s.mode||meta.defaultMode, (s.notes||'').replaceAll('\n',' ')
      ]);
      const csv = [headers, ...rows].map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
      download(`${meta.planName||'trip'}-itinerary.csv`, csv);
    }
    function exportJSON(){
      const payload = { meta, stops, route: computeRoute(), generatedAt: new Date().toISOString() };
      download(`${meta.planName||'trip'}.json`, JSON.stringify(payload, null, 2));
    }
    function importJSON(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(data.meta) Object.assign(meta, data.meta);
          if(Array.isArray(data.stops)) stops = data.stops;
          renderAll();
        }catch(e){ alert('Invalid JSON file'); }
      };
      reader.readAsText(file);
    }

    // ---------- Events ----------
    document.getElementById('btnAdd').onclick = ()=>addStop();
    document.getElementById('btnOptimize').onclick = ()=>optimize();
    document.getElementById('btnExportCSV').onclick = ()=>exportCSV();
    document.getElementById('btnExportJSON').onclick = ()=>exportJSON();
    document.getElementById('importJSON').onchange = (e)=>{ if(e.target.files?.[0]) importJSON(e.target.files[0]); };
    // Clicking the label opens file input
    document.querySelector('label.btn').onclick = ()=> document.getElementById('importJSON').click();

    // ---------- Utils ----------
    function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
    function escapeHtml(s=''){
      return s.replace(/[&<>"] /g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"," ":"&nbsp;"}[c]));
    }

    // ---------- Init ----------
    // Seed one example stop at Madrid
    addStop({lat:40.4168, lng:-3.7038}, {name:'Office'});
    renderAll();
  </script>
</body>
</html>
